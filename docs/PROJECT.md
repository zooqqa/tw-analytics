# TW Buy Stat - Проект сквозной аналитики

## Суть проекта
Объединение данных из треккера TrafficWave и рекламных источников (Moloco, Facebook, Google Ads) для анализа эффективности кампаний и офферов.

## Цель MVP
Единая таблица для медиабайеров с фильтрацией и метриками ROI/прибыли для принятия решений о переключении трафика.

## Ключевые пользователи
- **Медиабайеры** - анализ кампаний, переключение офферов
- **Аффилейт-менеджеры** - управление офферами, отслеживание капов
- **Собственник/CFO** - финансовые показатели, прибыльность

## Архитектура данных

### Источники данных
- **TrafficWave (TW)** - данные о конверсиях, доходах (tw_*)
- **Moloco** - данные о тратах, показах, кликах (m_*)

### Схема БД
```sql
-- История загрузок
data_loads (id, source, file_name, status, records_total, records_valid, started_at, finished_at)

-- Сырые данные
tw_events (все поля TW с префиксом tw_*)
moloco_events (все поля Moloco с префиксом m_*)

-- Витрина для UI
campaign_statistics (объединенные данные + расчетные метрики)
```

### Ключевые метрики
- `profit = tw_income_usd - m_spend`
- `roi_pct = (profit / m_spend) * 100`
- `calculated_cpi = m_spend / tw_installations`
- `tw_install2reg = (tw_registrations / tw_installations) * 100`
- `tw_reg2dep = (tw_first_purchases / tw_registrations) * 100`

## Функционал MVP

### Загрузка данных
```bash
python -m src.main --tw tw.csv --moloco moloco.csv
```

### UI возможности
- **Два режима**: плоская таблица / иерархическая (кампании → офферы)
- **Фильтрация**: текстовые (содержит/не содержит), числовые (больше/меньше), даты, гео
- **Независимость**: фильтр по скрытым колонкам
- **Сортировка**: по любой колонке
- **Выбор колонок**: настройка видимости

### API эндпоинты
- `GET /` - главная страница
- `GET /table` - плоская таблица
- `GET /table/hierarchical` - иерархическая таблица
- `GET /stats` - агрегированная статистика
- `GET /loads` - история загрузок

## Технологический стек
- **Backend**: Python 3.11+, FastAPI, SQLAlchemy, Pandas
- **Frontend**: Vanilla JS, HTML, CSS
- **БД**: SQLite (dev) / PostgreSQL (prod)
- **Деплой**: Uvicorn

## Принципы обработки данных

### Загрузка
1. CSV → валидация → нормализация → сохранение в БД
2. Журналирование всех операций в `data_loads`
3. Обработка ошибок с детальными логами

### Мерж данных
- Объединение по ключу: `(дата, кампания)`
- Сохранение всех полей с префиксами
- Расчет метрик по единым формулам

### Агрегация
- Суммирование абсолютных значений
- Пересчет процентных метрик от агрегированных сумм
- Обработка деления на ноль (NULL)

## Планы развития

### Этап 0 (следующий)
- Инкрементальная загрузка
- UI для истории загрузок
- Пресеты фильтров
- Экспорт данных (CSV/Excel)
- Unit тесты

### Этап 1
- Управление офферами (CRUD)
- Мониторинг капов и KPI
- Автоматические уведомления

### Этап 2
- API интеграции (вместо CSV)
- Прогнозирование бюджета
- Рекомендательная система

## Требования к данным

### TrafficWave CSV
Обязательные поля: `date`, `campaign_name`, `offer_name`, `installs`, `registrations`, `first_purchases`, `income_usd`

### Moloco CSV
Обязательные поля: `date`, `campaign_name`, `impressions`, `clicks`, `installs`, `spend`

## Критерии готовности MVP
✅ Все реализовано и работает:
1. Загрузка CSV через CLI
2. Витрина с префиксами tw_/m_
3. Расчет метрик по единым формулам
4. UI с двумя режимами таблиц
5. Система фильтрации одной кнопкой
6. Независимость фильтров и колонок
7. Иерархическое отображение
8. История загрузок