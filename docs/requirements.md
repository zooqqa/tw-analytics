# Требования к системе сквозной аналитики

Документ фиксирует функциональные, нефункциональные и организационные требования. Используется как источник истины для команды разработки, QA и заказчика.

## 1. Глоссарий

- **TW** — TrafficWave, трекер (источник дохода, постбеки, офферы).
- **Moloco** — рекламный источник (расходы, кампании, креативы).
- **Campaign** — рекламная кампания в источнике (Moloco, далее Facebook/Google).
- **Offer** — предложение/продукт партнёрской программы.
- **Cap** — лимит на оффер/кампанию (установки, депозиты, доход).
- **KPI** — требования партнёра (конверсии, повторные депозиты и т.п.).
- **Receivable** — задолженность партнёрской программы перед компанией.
- **ROI** — метрика эффективности (`(revenue - cost) / cost * 100`).
- **Load** — операция загрузки данных (CSV или API).

## 2. Общие требования

1. Система должна объединять данные из TW и Moloco с сохранением всех исходных колонок (префиксы `tw_` и `m_`).
2. Первоначально загрузка через CSV вручную, позже — автоматизация через API.
3. Все оригинальные файлы сохраняются и доступны для аудита.
4. Пользователи медиабаинга должны получать актуальные метрики по кампаниям и офферам, фильтровать и анализировать данные.
5. Аффилейт-менеджер должен управлять офферами, капами, партнёрками.
6. Финансовый блок должен видеть прибыль/убыток, бюджет, задолженности.
7. Система должна поддерживать поэтапное расширение без «ломки» текущего функционала.

## 3. Функциональные требования (MVP)

### 3.1 Загрузка данных
- Поддержка CSV форматов TW и Moloco (см. раздел 8).
- Интерфейс (UI/API) для загрузки файлов с отображением статуса и логом ошибок.
- Сохранение файлов на диск/S3, регистрация `load_id`, контроль хэша.
- Валидация: обязательные поля, формат дат, числовые диапазоны, отсутствие дублей.
- Возможность повторной загрузки с перерасчётом витрины.

### 3.2 Хранилище
- PostgreSQL с таблицами `tw_events`, `moloco_events`, `merged_campaigns`, `data_loads`, `alerts` и др.
- Приведение данных к единым типам, хранение `load_id` и `source_file`.
- Формулы расчётных полей согласованы и документированы.

### 3.3 Аналитический интерфейс
- Таблица с данными кампаний/офферов + расчётные метрики.
- Фильтр в виде одной кнопки (попап) с условиями `contains/not_contains`, `>=/<=`, диапазоны дат, чекбоксы (`hide_zero_cost`, `hide_zero_revenue`).
- Группировка по кампаниям и офферам, пересчёт агрегатов.
- История загрузок и алерты доступны в UI.

### 3.4 Алерты
- Система предупреждений (ROI < 0, ROI < порога, spend без конверсий, отсутствующие данные).
- Конфигурация порогов (файл/таблица), отображение в UI.
- Логирование алертов и отметка состояния (активен/решён).

### 3.5 Отчёты
- Сводные таблицы по кампаниям, офферам, датам.
- Возможность выгрузки текущей выборки в JSON.
- Документация с описанием метрик.

## 4. Функциональные требования (доработки)

### 4.1 Управление офферами и партнёрками
- Реестр офферов с версиями (SCD2), параметрами, связью с TW.
- Управление капами, KPI, ставками, прелендами.
- База партнёрских программ, условия выплат, контакты.

### 4.2 Финансы
- P&L отчёты, бюджеты, план/факт.
- Учёт дебиторки (`receivables`, AR aging), календарь выплат.
- Таблица курсов валют, конвертация в базовую валюту.

### 4.3 Аутентификация и RBAC
- Роли (медиабаер, аффилейт, финансы, админ, read-only).
- Аудит изменений по ключевым сущностям.
- Настройка прав доступа по модулям.

### 4.4 Автоматизация
- Коннекторы к TW/Moloco API, позже к Facebook/Google/TikTok.
- Движок правил (условие → действие), интеграции с внешними системами (Telegram/Slack/email).
- Алерты по расширенному набору порогов.

### 4.5 Аналитика и ML
- Аналитика креативов, A/B тесты.
- Модели прогнозирования KPI, ROI, капов.
- Детекция аномалий, рекомендации.
- ИИ-помощник для генерации отчётов и ответов на вопросы (человек принимает решение).

## 5. Нефункциональные требования

### 5.1 Производительность
- Загрузка CSV до 100k строк должна выполняться < 5 минут.
- UI таблица должна обрабатывать до 50k строк с виртуализацией.
- API `/api/data` должен отвечать ≤ 3 секунд при фильтрации.

### 5.2 Надёжность
- История загрузок и оригинальных файлов хранится минимум 12 месяцев.
- Повторяющиеся загрузки не должны приводить к дублированию данных.
- Валидация должна отсекать некорректные записи и сохранять лог.

### 5.3 Масштабируемость
- Возможность вынести витрины в отдельное хранилище (ClickHouse/BigQuery) без переписывания ядра.
- Горизонтальное масштабирование API и фронтенда (через Kubernetes).

### 5.4 Безопасность
- Минимум PII, шифрование секретов.
- RBAC + аудит (этап 6).
- Соответствие GDPR, возможность удалить данные по запросу (если появится PII).

### 5.5 Поддерживаемость
- Миграции БД через Alembic.
- Логи и мониторинг (Prometheus/Grafana, Sentry).
- Документация в репозитории (architecture.md, mvp_plan.md, features_plan.md).
- Runbook для ETL и алертов.

## 6. Ограничения

- На первом этапе нет автоматической аутентификации — только «общая» панель (до этапа 6).
- Все значения валют — USD; если источник другой валюты, курс предоставляется в CSV/конфиге.
- Интеграция с внешними источниками (Facebook/Google) откладывается до этапа 9.
- ИИ/ML — только после накопления достаточного объёма данных (≥ 50k событий/сегмент).

## 7. Интерфейсные требования

- Единый фильтр (кнопка → попап) с поддержкой множественных значений, пресетов, сохранения в `localStorage`.
- Таблица с возможностью скрывать/перетаскивать столбцы.
- Страница истории загрузок (`load_id`, файл, дата, статус, ошибки).
- Раздел «Алерты» с фильтрацией по статусу и важности.
- Tooltip/документация по метрикам (встроенные подсказки).

## 8. Форматы данных

### 8.1 TrafficWave CSV (`data.csv`)
- Разделитель `;`, кодировка UTF-8.
- Обязательные поля: `link_title`, `ad_campaign_name`, `date`, `geo_country_code`, метрики (registrations, installations, first_purchases, income_usd).
- Допускается отсутствие значений (пустые ячейки) — преобразуются в NULL/0 согласно бизнес-логике.

### 8.2 Moloco CSV (`report_YYYYMMDD-YYYYMMDD.csv`)
- Разделитель `,`, кодировка UTF-8.
- Обязательные поля: `Date`, `Campaign`, `Campaign ID`, `Impression`, `Click`, `Spend`, `Currency`.
- Даты в формате `YYYY-MM-DD`.

### 8.3 Выходные данные API
- JSON, поля в `snake_case`.
- Числовые значения передаются как числа (не строки).
- Дата/время в ISO-8601 UTC.

## 9. Тестирование

- Unit-тесты расчётных функций (ROI, KPI, агрегации).
- Интеграционные тесты ETL (валидный CSV, CSV с ошибками, повторная загрузка).
- UI-тесты фильтрации.
- Smoke-тесты API (health, data, uploads, stats).
- Проверка производительности (нагрузка на `/api/data`).

## 10. Процессы и реализация

- Разработка ведётся по планам `docs/mvp_plan.md` и `docs/features_plan.md`.
- Любые отклонения обсуждаются до реализации, фиксируются в `docs/idea.md`/issue tracker.
- Каждое изменение сопровождается обновлением документации (архитектура, требования, планы).
- Еженедельные демо и ретроспективы.

---

Требования пересматриваются по мере прогресса (после завершения каждого этапа) и согласуются с заказчиком. Документ является «живым» и обновляется синхронно с кодом и архитектурой.

