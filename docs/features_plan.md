# План доработки фич - Сервис сквозной аналитики

## Обзор

План развития системы после MVP с добавлением продвинутых функций для управления офферами, финансового учета, аутентификации и автоматизации.

## Этап 0: Отложенные функции MVP (низкий приоритет)

Эти функции были отложены из MVP для ускорения запуска основной функциональности:

### 0.1 Инкрементальная загрузка данных
- Вместо полного удаления данных при загрузке - upsert по ключам
- Хранение истории загрузок с возможностью отката
- Версионирование данных с `load_id` и `is_active` флагом
- Поддержка дедупликации по хешу файла

### 0.2 История загрузок в UI
- Страница/раздел с историей всех загрузок
- Отображение статуса (успех/ошибка), количества записей, времени
- Ссылка на лог-файлы ошибок
- Возможность откатить к предыдущей загрузке

### 0.3 Пресеты фильтров
- Сохранение текущих настроек фильтра под именем
- Загрузка сохраненных пресетов
- Экспорт/импорт пресетов (JSON)
- Хранение в `localStorage` или БД (для shared пресетов)

### 0.4 Экспорт данных
- Экспорт текущей выборки в CSV
- Экспорт в JSON для интеграций
- Экспорт в Excel с форматированием
- Учет текущих фильтров и выбранных колонок

### 0.5 Индикация загрузки
- Спиннер/прогресс-бар при загрузке CSV через UI
- WebSocket или polling для отслеживания прогресса
- Уведомления об успешной/неудачной загрузке
- Возможность отменить загрузку

### 0.6 Unit и Integration тесты
- Unit тесты для расчетных функций (ROI, метрики, агрегация)
- Integration тесты для ETL (валидация, загрузка, обработка ошибок)
- UI тесты для фильтрации
- Smoke тесты для API endpoints

### 0.7 Обработка ошибок в UI
- Toast-уведомления при ошибках API
- Retry логика для failed requests
- Graceful degradation при недоступности backend
- Детальные сообщения об ошибках для пользователя

## Этап 4: Управление офферами и партнёрками (2-3 недели)

### 4.1 Каноническая модель офферов

**Цели:** обеспечить централизованное хранение офферов, их условий, истории изменений и связь с реальными событиями из TW.

**Схема таблиц:**
- `offers` (`id`, `offer_code`, `name`, `product`, `affiliate_program_id`, `status`, `created_at`, `updated_at`)
- `offer_versions` (`id`, `offer_id`, `valid_from`, `valid_to`, `geo`, `rate`, `currency`, `kpi_policy_id`, `cap_policy_id`, `landing_type`, `approach`, `notes`, `author_id`)
- `offer_geo` (связь `offer_version_id` ↔ список GEO)
- `offer_mapping` (`offer_id`, `tw_offer_identifier`, `tw_link_title`, `is_active`) — связывает оффер с данными из трекера
- `affiliate_programs` (`id`, `name`, `contact`, `payment_terms`, `payment_schedule`, `hold_days`, `currency`, `status`)
- `affiliate_contacts` (email, Telegram, preferred_channel)
- `kpi_policies` (`id`, `name`, `formula`, `window_days`, `description`, `is_active`)
- `cap_policies` (`id`, `name`, `metric`, `limit_value`, `period`, `reset_time`, `priority`, `auto_pause`) 
- `offer_audit_log` (`id`, `offer_id`, `changed_field`, `old_value`, `new_value`, `changed_by`, `changed_at`)

**CRUD и бизнес-правила:**
- Создание/редактирование/архивирование офферов происходит через версии (SCD2): нельзя изменять запись задним числом, вместо этого открывается новая версия с `valid_from`.
- Проверка пересечения версий: одна дата не может попадать в несколько активных версий.
- При деактивации оффера закрываются все активные версии (`valid_to = NOW()`).
- Нельзя удалить оффер, если он используется в событиях TW; архивное состояние допускается.
- Форма оффера включает автоматический подбор `tw_link_title` из загруженных данных (подсказки).

**Интерфейс:**
- Таблица офферов с фильтрацией по GEO/статусу/партнёрке.
- Детальная карточка оффера с вкладками: «Параметры», «История изменений», «Связанные кампании», «Капы», «KPI».
- Массовые операции (смена статуса, экспорт для согласования).
- Поиск по `offer_code`, названию, партнёрке, GEO.

### 4.2 Управление партнёрскими программами

**Функциональность:**
- Регистрация новых партнёрок, их статусов и условий выплат.
- Хранение графика (NET7/NET30, еженедельные дни выплат, холд).
- Поля: `default_currency`, `min_payout`, `invoice_email`, `timezone`, `payment_channels`.
- Уведомления о приближении дат выплат (интеграция с календарём/алертами из этапа 7).
- Журнал контактов и договорённостей (комментарии с метками времени).

**Интерфейс:**
- Список партнёрок с основными метриками (долг, сумма выплат за период, последний контакт).
- Календарь выплат (интеграция с финансовым модулем).
- Сводка для каждой партнёрки: активные офферы, текущие KPI, суммы дебиторки.

### 4.3 Мониторинг капов

**Расчёты:**
- `cap_usage = qualified_events / limit_value` по выбранному периоду (день/неделя/месяц).
- Прогноз исчерпания на основе текущего темпа (например, линейная экстраполяция или EMA).
- Поддержка разных метрик капа: `first_deposits`, `revenue`, `clicks`.

**Функции:**
- Настройка лимитов в UI (связь с `cap_policies`).
- Алгоритм «предупредить за N часов» (информация из `cap_policies.alert_threshold`).
- Статусы: `ok`, `warning`, `critical`, `paused`.
- Возможность вручную сбросить/увеличить лимит.

**Интеграция с алертами:**
- Запись в таблицу `alerts` при достижении порогов.
- Лог действий (кто и когда изменил кап).

**Отчётность:**
- Дашборд остатка капов по офферам и партнёркам.
- История изменений лимитов.
- Экспорт (JSON/CSV) для сторонних систем (по необходимости).

-
## Этап 5: Финансовый модуль и прогнозирование (1-2 недели)

### 5.1 P&L и бюджетирование

**Центры прибыли:**
- кампании, офферы, партнёрки, GEO, источники.
- возможность группировки по менеджерам/аккаунтам.

**Функциональность:**
- P&L отчёт с выбором периода, сравнение `план/факт`.
- Обработка конверсий с учётом KPI (используем `kpi_policies`, `payout_rules`).
- Валюта: стандартная валюта отчётов (USD), таблица курсов `fx_rates` (ежедневный справочник + API для обновления).
- Поддержка корректировок (chargebacks, adjustments) — отдельная таблица `revenue_adjustments`.

**Прогноз:**
- Недельный прогноз бюджета (на основе трат и планов капов).
- Прогноз входящих выплат (используя график партнёрок и статус дебиторки).
- Сводка cash-flow: `expected_cash_in`, `expected_cash_out`, `net_position`.

### 5.2 Управление дебиторкой (Accounts Receivable)

**Таблицы и процессы:**
- `receivables` (`id`, `affiliate_program_id`, `period_start`, `period_end`, `amount`, `currency`, `status`, `due_date`, `expected_date`, `paid_date`, `notes`)
- `receivable_items` связывает с конкретными `revenue` событиями.
- `payments` (`id`, `affiliate_program_id`, `amount`, `payment_date`, `reference`, `currency`).
- `ar_aging_view` — представление для возрастной структуры (0-30, 31-60, 61-90, 90+).

**Функции:**
- Автоматическое формирование `receivables` из доходов, прошедших KPI, согласно условиям партнёрки.
- Возможность вручную корректировать (частичная оплата, перенос срока, списание).
- Отчёт «Состояние дебиторки» и уведомления о просрочках.
- Связь с календарём выплат.

### 5.3 Учёт расходов и бюджета

- Таблица `expenses` для дополнительных расходов (подписки, сервисы).
- План-факт бюджета по источникам и гео.
- Возможность загрузки бюджета (CSV) и сравнения с фактическими затратами.
- Визуализация планового и фактического расхода по времени.

## Этап 6: Аутентификация, авторизация и аудит (1-2 недели)

### 6.1 Пользователи и роли

- Внедрение RBAC (например, через Keycloak/Auth0 либо кастомный модуль на JWT).
- Роли: `media_buyer`, `affiliate_manager`, `finance`, `admin`, `read_only`.
- Матричная схема доступа по модулям (просмотр ETL, редактирование офферов, финансы и т.д.).
- Поддержка `impersonation` для администраторов (по согласованию).

### 6.2 Аудит и безопасность

- Таблица `audit_log` (`id`, `user_id`, `action`, `resource`, `payload`, `created_at`).
- Запись всех CRUD операций по офферам, партнёркам, финансовым данным.
- Политики паролей, MFA (по возможности), ограничение по IP.
- Журнал сессий, автоматический таймаут.
- Уведомления об изменении критичных параметров (ставка оффера, кап, выплаты).

### 6.3 Управление настройками

- UI для конфигурации алертов, порогов, валют.
- Возможность создавать «workspace»/«account» для разделения данных между командами (будущее расширение).

## Этап 7: Интеграции и автоматизация (2-3 недели)

### 7.1 API-коннекторы и интеграционный слой

- Разработка коннекторов к TrafficWave и Moloco (REST/GraphQL, OAuth/ключи).
- Идемпотентность: ключи (`campaign_id + date`, `event_id`), дедупликация в ETL.
- Хранение токенов в зашифрованном виде (Vault/Secret Manager).
- Обработка ретроспективных изменений (replay последних X дней).
- Логирование запросов/ответов, retry политика, алерты при сбоях.
- Абстракция «источник» (interface), чтобы позже подключать Facebook/Google без переписывания ядра.

### 7.2 Система правил и автодействий

- DSL или UI-конструктор: `if condition then action`.
- Возможность создавать правила из UI (привязка к офферу, кампании, гео).
- Хранение в таблице `automation_rules` (`id`, `name`, `scope`, `condition`, `action`, `priority`, `is_active`).
- Журнал срабатываний `automation_log` (когда, что, какое действие).
- Интеграция с внешними сервисами (webhook, Slack, Telegram, email).
- Поддержка ручного подтверждения (action = `suggest`, требует подтверждения в UI).

### 7.3 Расширение алертов

- Интеграция с Telegram/Slack (вебхуки, формат сообщений, rate limiting).
- Каналы уведомлений настраиваются перс. пользователями (привязка Telegram ID и т.д.).
- Dashboard «Post-mortem» — список критических событий и действий.

## Этап 8: Расширенная аналитика и ML (3-4 недели)

### 8.1 Аналитика креативов

- Добавление в модель данных `creatives`, `ad_groups`.
- Витрина `creative_performance` с метриками CTR, CPC, CPI, ROAS.
- A/B тесты: хранение групп, измерение uplift.
- Визуализация влияния креативов на KPI офферов.

### 8.2 ML модели

- Требование к данным: накопление ≥ 50k событий на сегмент.
- Pipeline: подготовка фич (feature store), обучение, оценка, деплой.
- Модели: вероятность FTD, прогноз repeat deposit, прогноз spend.
- Задачи: рекомендации офферов, оценка риска невыполнения KPI.
- Метрики качества, A/B проверка внедрения (impact на прибыль/ROI).
- Мониторинг моделей (drift, retraining schedule).

### 8.3 Детекция аномалий

- Алгоритмы (Isolation Forest, Prophet, статистические пороги) на ряде `spend`, `conversion rate`.
- Автоматические алерты и запись в журнал.
- UI для подтверждения/отклонения аномалий, обратная связь для моделей.

## Этап 9: Подключение дополнительных источников (2-3 недели)

- Единое API для создания коннектора (интерфейсы, adaptor pattern).
- Реализация для Facebook Ads: OAuth, загрузка кампаний, ad sets, креативов.
- Google Ads: поддержка MCC, синхронизация ключевых слов, затраты.
- TikTok Ads: авторизация, сбор метрик, ограничение по rate limit.
- Планирование обновлений: расписание, retry/backoff.
- Нормализация метрик (приведение к общей схеме `spend`, `impressions`, `clicks`).

## Этап 10: Продвинутые функции (4-5 недель)

### 10.1 ИИ-помощник и автоотчёты

- LLM-интерфейс с ограничением прав (читать данные через API, без прямого доступа к БД).
- Протокол вопросов и ответов, сохранение истории запросов.
- Генерация текстовых отчётов по шаблонам (дневные/недельные сводки для медиабаеров, финансов).
- Возможность задавать вопросы на естественном языке (например, «Какие офферы просели по ROI за последнюю неделю?»).
- Ограничение: ИИ не принимает финальных решений, только рекомендации.

### 10.2 Мобильный доступ

- PWA или нативное приложение.
- Экран сводки (ключевые KPI, алерты, капы, выплаты).
- Push-уведомления (FCM/APNs).
- Возможность подтвердить/отклонить действие (например, паузу кампании).

### 10.3 Расширенная автоматизация

- Machine learning в автодействиях (обучение на прошлых срабатываниях).
- Поддержка сценариев («если ROI падает второй день подряд и кап < 20%, то уменьшить бюджет на 30%»).
- Интеграции с трекером/источником для изменения ставок/стопа кампаний (где это разрешено API).

## Технологический стек (Scale-up)

### Backend
- **FastAPI** / **GraphQL** (gql) для сложных выборок
- **PostgreSQL** + **TimescaleDB** (таймсерии) + **ClickHouse/BigQuery** (при росте объёма)
- **Redis** — кэш, очереди
- **Celery / Dramatiq** — асинхронные задачи
- **SQLAlchemy**, **Pydantic v2**
- **Dagster / Airflow** — оркестрация ETL
- **Prefect** или **Great Expectations** — продвинутые DQ-пайплайны

### Frontend
- **React + TypeScript**
- **Material UI**
- **TanStack Query**
- **Recharts / Apache ECharts**
- **Nx / Turborepo** для монорепы

### ML/AI
- **scikit-learn**, **LightGBM**, **Prophet**, **PyTorch**
- **MLflow** / **Weights & Biases** — трекинг экспериментов
- **Feature store** (Feast) при необходимости

### Инфраструктура
- **Docker** + **Kubernetes** (прод)
- **Nginx / Traefik** — ingress
- **Vault** — секреты
- **Prometheus + Grafana** — мониторинг
- **ELK / OpenSearch** — логи
- **Sentry** — ошибки
- **Terraform / Ansible** — IaC
- **CI/CD** (GitHub Actions / GitLab CI / Argo)

## Приоритеты и зависимости

**Высокий приоритет:**
1. Канонический реестр офферов и партнёрских программ (этап 4)
2. Финансовый модуль (этап 5)
3. RBAC и аудит (этап 6)
4. Интеграции и правила (этап 7)

**Средний приоритет:**
1. Аналитика креативов и ML (этап 8)
2. Подключение новых источников (этап 9)
3. Расширенные алерты и автоматизация (этап 7.3, 10.3)

**Низкий приоритет:**
1. ИИ-помощник (этап 10.1)
2. Мобильное приложение (этап 10.2)
3. Продвинутые LLM/ML сценарии (этап 10.3)

## Временные рамки (оценочно)

- **Этап 4**: 2-3 недели
- **Этап 5**: 1-2 недели
- **Этап 6**: 1-2 недели
- **Этап 7**: 2-3 недели
- **Этап 8**: 3-4 недели
- **Этап 9**: 2-3 недели
- **Этап 10**: 4-5 недель
- **Итого**: 15-22 недель (при последовательной реализации + буфер на интеграции)

## Итог

После выполнения плана система превратится в полнофункциональную платформу управления арбитражем трафика: с версионируемыми офферами, управлением партнёрами и финансовыми потоками, гибким RBAC, автоматизацией процессов, интеграциями с внешними источниками и аналитикой на базе ML/AI. Каждый этап расширяет возможности без нарушений архитектуры и требований бизнеса, а закладываемая инфраструктура обеспечивает масштабируемость и стабильность.

## Этап 5: Финансовый модуль (1-2 недели)

### 5.1 P&L отчеты

**Прибыльность по срезам:**
- По кампаниям
- По офферам
- По гео
- По партнеркам
- По периодам

**Сводные показатели:**
- Общая прибыль/убыток
- ROI по направлениям
- Топ/аут офферов
- Тренды эффективности

**Прогнозирование:**
- Недельный прогноз бюджета
- Ожидаемые выплаты
- Планирование трат

### 5.2 Управление дебиторкой

**AR Aging:**
- 0-30 дней
- 31-60 дней
- 61-90 дней
- 90+ дней

**Планирование кэша:**
- Входящие платежи
- Исходящие траты
- Баланс компании
- Критические периоды

## Этап 6: Аутентификация и авторизация (1-2 недели)

### 6.1 Система пользователей

**Регистрация и авторизация:**
- Регистрация новых пользователей
- Вход в систему
- Восстановление пароля
- Профиль пользователя

**Роли и права:**
- Медиабайер (только аналитика)
- Аффилейт-менеджер (офферы + аналитика)
- Финансист (финансы + аналитика)
- Администратор (все права)

**Управление доступом:**
- Назначение ролей
- Ограничение доступа к модулям
- Аудит действий пользователей

## Этап 7: Интеграции и автоматизация (2-3 недели)

### 7.1 API коннекторы

**TrafficWave API:**
- Автоматическая синхронизация данных
- Получение событий в реальном времени
- Синхронизация кампаний и офферов

**Moloco API:**
- Загрузка данных о тратах
- Синхронизация креативов
- Получение метрик в реальном времени

**Другие источники:**
- Facebook Ads API
- Google Ads API
- TikTok Ads API

### 7.2 Система правил

**Настройка автоматических действий:**
- Правила паузы кампаний
- Переключение офферов
- Уведомления о проблемах
- Автоматические отчеты

**Условия срабатывания:**
- ROI ниже порога
- Исчерпание капов
- Отсутствие конверсий
- Превышение бюджета

**Действия:**
- Пауза кампании
- Переключение на другой оффер
- Отправка уведомления
- Создание задачи

## Этап 8: Расширенная аналитика (3-4 недели)

### 8.1 Аналитика креативов

**Эффективность креативов:**
- Сравнение креативов внутри кампаний
- A/B тестирование
- Рекомендации по оптимизации
- Тренды эффективности

**Детализация по креативам:**
- CTR по креативам
- Конверсии по креативам
- Стоимость за конверсию
- ROI по креативам

### 8.2 ML модели

**Прогнозирование:**
- Вероятность конверсии
- Прогноз ROI
- Оптимальный бюджет
- Время до исчерпания капа

**Рекомендации:**
- Лучшие офферы для кампании
- Оптимальные креативы
- Рекомендуемые ставки
- Время для паузы кампании

**Детекция аномалий:**
- Необычные паттерны трат
- Подозрительная активность
- Технические проблемы
- Фрод-индикаторы

## Этап 9: Дополнительные источники (2-3 недели)

### 9.1 Facebook Ads

**Интеграция:**
- Подключение Facebook Marketing API
- Синхронизация кампаний и креативов
- Загрузка метрик трат
- Управление кампаниями

**Специфичные метрики:**
- CTR, CPC, CPM
- Частота показов
- Охват и показы
- Качество аудитории

### 9.2 Google Ads

**Интеграция:**
- Google Ads API
- Синхронизация кампаний
- Загрузка данных о тратах
- Управление ставками

**Специфичные метрики:**
- Quality Score
- Impression Share
- Click Share
- Search Terms

### 9.3 TikTok Ads

**Интеграция:**
- TikTok Ads API
- Синхронизация креативов
- Загрузка метрик
- Управление кампаниями

## Этап 10: Продвинутые функции (4-5 недель)

### 10.1 ИИ помощник

**Чат-бот для анализа:**
- Ответы на вопросы о данных
- Генерация отчетов
- Объяснение трендов
- Рекомендации по оптимизации

**Генерация отчетов:**
- Автоматические сводки
- Еженедельные отчеты
- Анализ эффективности
- Рекомендации по действиям

### 10.2 Мобильное приложение

**Уведомления:**
- Push-уведомления о проблемах
- Алерты о критических событиях
- Ежедневные сводки
- Напоминания о задачах

**Быстрый доступ:**
- Ключевые метрики
- Статус кампаний
- Топ офферов
- Финансовые показатели

### 10.3 Расширенная автоматизация

**Умные правила:**
- Машинное обучение для правил
- Адаптивные пороги
- Контекстные действия
- Обучение на исторических данных

**Интеграции с внешними системами:**
- Slack уведомления
- Telegram боты
- Email рассылки
- Webhook интеграции

## Технологический стек для доработки

### Backend
- **FastAPI** - основной фреймворк
- **PostgreSQL** - основная БД
- **Redis** - кэширование и очереди
- **Celery** - асинхронные задачи
- **SQLAlchemy** - ORM
- **Pydantic** - валидация данных

### Frontend
- **React + TypeScript** - SPA
- **Material-UI** - компоненты
- **Chart.js** - графики
- **React Query** - управление состоянием
- **React Router** - маршрутизация

### ML/AI
- **Scikit-learn** - ML модели
- **Pandas** - обработка данных
- **NumPy** - вычисления
- **OpenAI API** - ИИ помощник

### Инфраструктура
- **Docker** - контейнеризация
- **Kubernetes** - оркестрация
- **Nginx** - веб-сервер
- **Prometheus + Grafana** - мониторинг
- **ELK Stack** - логирование

## Приоритеты реализации

### Высокий приоритет
1. Управление офферами
2. Аутентификация
3. API коннекторы
4. Финансовый модуль

### Средний приоритет
1. Аналитика креативов
2. Система правил
3. Дополнительные источники
4. ML модели

### Низкий приоритет
1. ИИ помощник
2. Мобильное приложение
3. Расширенная автоматизация

## Временные рамки

- **Этап 4**: 2-3 недели
- **Этап 5**: 1-2 недели
- **Этап 6**: 1-2 недели
- **Этап 7**: 2-3 недели
- **Этап 8**: 3-4 недели
- **Этап 9**: 2-3 недели
- **Этап 10**: 4-5 недели
- **Итого**: 15-22 недели

## Результат доработки

Полнофункциональная система управления арбитражем трафика с:
- Управлением офферами и партнерками
- Финансовым учетом и планированием
- Автоматизацией рутинных процессов
- ИИ-помощником для анализа
- Интеграциями с основными рекламными платформами
- Мобильным доступом
- Продвинутой аналитикой и прогнозированием
